## 汇编语言讲解（二）



#### 查看cpu和内存，用机器指令和汇编指令编程

**预备知识**：Debug的使用

之后的讲解中都会使用到Debug程序，首先学习一下他的主要用法

- 什么时Debug？

  Debug是Dos、Windows都提供的实模式程序的调整工具，使用它，可以查看cpu各种寄存器中的内容、内存的情况和机器码级跟踪程序的运行

- 我们用到的Debug功能

  ```
  1、用Debug的R命令查看、改变cpu寄存器的内容
  2、用Debug的D命令查看内存中的内容
  3、用Debug的E命令改写内存中的内容
  4、用Debug的U命令将内存中的机器指令翻译成汇编指令
  5、用Debug的T命令执行一个机器指令
  6、用Debug的A命令以汇编指令的格式在内存中写入一条机器指令
  
  注意：不区分大小写
  ```

- **进入Debug**：Debug是DOS方式下使用的程序，我们在进入Debug前，应先进入到DOS方式。用以下的方式可以进入DOS，重启计算机，进入DOS方式属于实模式的DOS；在windows中进入DOS方式，此时进入的虚DOS。 以后我们可以使用Debug模式来编写汇编语言。

  ```
  1、安装DOSBox0.74-win32-installer
  2、在D盘建立名为“debug”的文件夹
  3、运行桌面的“DOSBox 0.74”
  
  此时会弹出两个窗口，在“dosbox0.74窗口里面输入如下命令”
  mount c: d:\debug
  
  然后输入命令
  c:
  最后输入debug进入汇编模式。
  ```

  ![1580979003021](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580979003021.png)



#### 实验1

使用Debug将上面的程序段写入内存，逐行执行，观察每条指令执行后，cpu中相关寄存器中内容的变化。

![1580980805387](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580980805387.png)

提示，可用E命令和A命令以两种方式将指令写入内存，注意用T命令执行时CS:IP的指向。

- 步骤1：使用a命令输入命令：

  ![1580981797150](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580981797150.png)

- 步骤2：使用-d来查看内存数据，我们可以使用-d指点要查看的数据

  ![1580981896904](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580981896904.png)

- 步骤3: 上面的看到的073F出现的是机器码，我们可以使用u来查看汇编格式

  ![1580982012350](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580982012350.png)

- 步骤4：下面我们开始准备执行命令了，首先我们要改变CS和IP的值才行

![1580982228536](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580982228536.png)

- 步骤5：我们使用t来运算单条机器指令，我们可以观察寄存器的变化

  ![1580982662742](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580982662742.png)

  使用quit来结束所有的命令。

  

#### 实验2

将下面3条指令写入从2000：0开始的内存单元中，利用这3条指令计算2的8次方。

- 先写入3条指令：

![1580983587393](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580983587393.png)

- 使用t命令执行代码

  ![r1580983662895](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580983662895.png)



#### 实验3

查看内存中的内容：pc机主板的ROM中写有一个生产日期，在内存FFF0H~FFFFFH的某几个单元中，请找到这个生产日期并试图修改

![1580984095710](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580984095710.png)

指定范围：（尝试使用e修改，失败）

![1580984316273](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580984316273.png)



#### 实验4

尝试输入下列命令，观察屏幕发生什么变化。

![1580984659214](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580984659214.png)

可以看到屏幕中的输出发生了变化，这是因为b810段是显存，我们往里面写什么，就显示什么。



### CPU和内存访问

#### 内存中字的存储

在0地址处开始存放20000（4E20H），记住一句话：**高位对应高地址**，如：0号单元是低地址单元，1号单元是高地址单元

![1580988369841](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580988369841.png)

根据上图回答下列问题：（注意：字型数据就要读取前后两个数据，字节型表示的是单个数据）

```
1、0地址单元存放的字节型数据是什么？  答：20H，32
2、0地址字单元中存放的字型数据是多少？ 答：4E20H，20000
3、2地址字单元中存放的字单元中存放的字节型数据是什么？ 答：12H
4、2地址单元中存放的字型数据是什么？ 答：0012H
5、1地址单元中存放的字型数据是什么？ 答：124EH
```

**结论：** 任意两个地址连续的内存单元，N号单元和N+1号单元，可以将他们看成两个内存单元，也可以看成一个地址为N的字单元中的高位字节单元和低位字节单元；

比如上图：1号和2号，可以看成两个内存单元；也可以看成是1地址字单元的高位字节2，1表示其低位字节。



#### DS和[address]

cpu要读取一个内存单元的时候，必须先给出这个内存单元的地址；在8086pc中，内存地址由段地址和偏移地址组成。8086cpu有一个DS寄存器，通常用来存放要访问的数据的**段地址**。

例如：我们要读取10000H单元的内容可以用如下程序段进行：（**将内存单元的数据读到寄存器中**）

```python
mov bx 1000H  # 这是因为它是段地址，在经过地址加法器的时候会乘以16
mov ds bx
mov al，[0]  # 下面我们会讲解mov的高级用法

# 上面三条指令将10000H(1000:0)中的数据读到al中。
```

注意： 上面的mov al,[0],已知的mov指令可完成的两种传递功能：

- 将数据直接送入寄存器；如 mov ax，12H
- 将一个寄存器中的内容送入另一个寄存器中；如 mov bx，ax
- 除此之外，mov指令还可以将一个内存单元中的内容送入一个寄存器；如：mov al，[0], 首先我们通过将段地址输入到ds中，然后通过mov al,[0],这里的[0],表示的是偏移地址，将这个偏移地址的数据读取到al中。 



**从哪个内存单元送到哪个寄存器中那？**

mov指令的格式： mov  寄存器名，内存单元地址

"[...]" 表示一个内存单元，"[...]"中的0表示内存单元的偏移地址。那么内存单元的段地址是多少？

```
执行指令时，8086cpu自动取DS中的数据为内存单元的段地址。
```



**如何用mov指令从10000H中读取数据？**

- 10000H表示为1000:0(段地址:偏移地址)
- 将段地址1000H放入ds
- 用mov al，[0]完成传送（mov 指令中的[]说明操作对象是一个内存单元，[]中的0说明这个内存单元的偏移地址是0，它的段地址默认放在ds中）



**能否用mov ds,1000H 这语句，直接将段地址输入到ds？**

答：不能，上面的代码演示中是通过bx，间接的将数据给ds了！原因是8086cpu不支持将数据送入段寄存器的操作，ds是段寄存器。但可以支持将数据输入通用寄存器中，通用寄存器可以将数据给段寄存器。

语句：**数据 --> 通用寄存器 --> 段寄存器**



**问题**：写几条指令，将al的数据送入内存单元10000H？怎样将数据从寄存器送入内存单元？（**将寄存器的数据送到内存单元中**）

```python
1、mov bx，1000H
2、mov ds,bx
3、mov [0],al  # 和之前的相反，因为段地址只能读通用寄存器，所以需要将段地址写道bx中，给ds后，[0]表示偏移地址
```



#### 字的传送

因为8086cpu是16位结构，有16根数据线，所以可以一次性传送16位的数据，也就是一次性传送一个字：

![1580994118392](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580994118392.png)

**注意：** 传送的数据，如果是16位的，需要ax接受，如果是ah、al则接受8位数据



例子：内存中的情况如下，写出下面指令执行后寄存器ax,bx,cx的值

![1580994946932](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580994946932.png)



解答步骤：

- 步骤一：将数据写入内存中

![1580994932572](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580994932572.png)

- 步骤二：切换CS、IP，执行语句

  ![1580995070886](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580995070886.png)

- 步骤三：

  ![1580995540085](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580995540085.png)

- 写入数据，最终方案：

  ![1580995505688](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580995505688.png)

- 准备开始输入指令

  ![1580995836678](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580995836678.png)

- 执行的结果

  ![1580996142111](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580996142111.png)

- 结果：

  ![1580996252047](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1580996252047.png)

